@page "/Statistik"

@using ordination_blazor.Komponenter
@using ordinationsapp.Data;
@using shared.Model;
@using ordinationsapp.Shared
@using ordinationsapp.Model;
@inject ApiService apiService

<div class="container">
    <h1>Vis statistik</h1>

    <strong>Ikke implementeret üò¢</strong>
    <br />

    <div class="row">
        <div class="col-md-12 border p-3">
            <h3>Antal ordinationer</h3>

            <div class="form-group row">
                <label for="v√¶gtfra" class="col-sm-4 col-form-label">V√¶gt fra</label>
                <div class="col-sm-8">
                    <input type="number" id="v√¶gtfra" @oninput="(ChangeEventArgs args) => HandleVaegtChange(args, true)">
                </div>
            </div>

            <div class="form-group row">
                <label for="v√¶gttil" class="col-sm-4 col-form-label">V√¶gt til</label>
                <div class="col-sm-8">
                    <input type="number" id="v√¶gttil" @oninput="(ChangeEventArgs args) => HandleVaegtChange(args, false)">
                </div>
            </div>

            <div class="form-group row">
                <label for="lm" class="col-sm-4 col-form-label">L√¶gemiddel</label>
                <div class="col-sm-8">
                    <InputSelect TValue="int" @bind-Value="@laegemiddelId" @oninput="OnLaegemiddelChange">
                        <option value="">V√¶lg l√¶gemiddel</option>
                        @foreach (var laegemiddel in laegemiddler)
                        {
                            <option value="@laegemiddel.LaegemiddelId">@laegemiddel.navn</option>
                        }
                    </InputSelect>
                </div>
            </div>
            <span style="color: red">@errorMessage</span>
        </div>

        <div class="col-md-12 border p-3">
            <h3>Resultat</h3>

            <div class="form-group col">
                <label>Antal Ordinationer: @antalPatienter</label>
                <div class="col-sm-8" style="display: flex; justify-content: center; width: 100%">
                    @if (antalPatienter > 0)
                    {
                        <div style="width: 90%">
                            <StatistikDropdown pns="pns" fast="fast" sk√¶v="sk√¶v" antalPatienter="antalPatienter" @ref="@dropdown"></StatistikDropdown>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>

</div>

@code {
    
    List<PNVaegtDTO> pns = new List<PNVaegtDTO>();
    List<DagligFastVaegtDTO> fast = new List<DagligFastVaegtDTO>();
    List<DagligSk√¶vVaegtDTO> sk√¶v = new List<DagligSk√¶vVaegtDTO>();

    public List<Laegemiddel> laegemiddler = new List<Laegemiddel>();
    public int laegemiddelId;

    StatistikDropdown? dropdown { get; set; }
    
    string errorMessage = "";
    
    int vaegtFra = 0;
    int vaegtTil = 0;

    int antalPatienter = 0;

    protected override async Task OnInitializedAsync()
    {
        var midler = await apiService.GetLaegemidler();
        laegemiddler = midler.ToList();
    }

    private async Task HandleVaegtChange(ChangeEventArgs e, bool fraVaegt)
    {
        var inString = e.Value!.ToString();
        bool erTal = fraVaegt ? int.TryParse(inString, out vaegtFra) : int.TryParse(inString, out vaegtTil);

        if (!erTal)
        {
            errorMessage = "V√¶gt skal v√¶re et helt tal";
            StateHasChanged();
            return;
        }
        if (vaegtFra < 0 || vaegtTil < 0)
        {
            errorMessage = "V√¶gt kan ikke v√¶re negativ";
            StateHasChanged();
            return;
        }

        if (vaegtFra > vaegtTil)
        {
            errorMessage = "V√¶gt fra kan ikke v√¶re mere end v√¶gt til";
            StateHasChanged();
            return;
        }

        errorMessage = "";
        
        // L√¶gemiddel er valgt
        if (laegemiddelId != 0)
        {
            var dto = await apiService.GetOrdinationerStatistik(vaegtFra, vaegtTil, laegemiddelId);
            if (dto != null)
            {
                antalPatienter = 0;
                if (dto.PNOrdinationer != null)
                {
                    pns = dto.PNOrdinationer;
                    antalPatienter += pns.Count;
                }

                if (dto.DagligFastOrdinationer != null)
                {
                    fast = dto.DagligFastOrdinationer;
                    antalPatienter += fast.Count;
                }

                if (dto.DagligSk√¶vOrdinationer != null)
                {
                    sk√¶v = dto.DagligSk√¶vOrdinationer;
                    antalPatienter += sk√¶v.Count;
                }
                
            }
            else
            {
                pns = new List<PNVaegtDTO>();
                fast = new List<DagligFastVaegtDTO>();
                sk√¶v = new List<DagligSk√¶vVaegtDTO>();
                antalPatienter = 0;
            }
        }
        else
        {
            errorMessage = "Et l√¶gemiddel skal indtastes";
        }
        
        StateHasChanged();
    }

    private async Task OnLaegemiddelChange(ChangeEventArgs e)
    {
        var valAsString = e.Value.ToString();
        if (!int.TryParse(valAsString, out laegemiddelId))
        {
            errorMessage = "Kunne ikke finde laegemiddel";
            StateHasChanged();
            return;
        }

        if (vaegtFra < 0 || vaegtTil < 0)
        {
            errorMessage = "V√¶gt kan ikke v√¶re negativ";
            StateHasChanged();
            return;
        }

        if (vaegtFra > vaegtTil)
        {
            errorMessage = "V√¶gt fra kan ikke v√¶re mere end v√¶gt til";
            StateHasChanged();
            return;
        }
        
        errorMessage = "";
        
        if (laegemiddelId != 0)
        {
            var dto = await apiService.GetOrdinationerStatistik(vaegtFra, vaegtTil, laegemiddelId);
            if (dto != null)
            {
                antalPatienter = 0;
                if (dto.PNOrdinationer != null)
                {
                    pns = dto.PNOrdinationer;
                    antalPatienter += pns.Count;
                }

                if (dto.DagligFastOrdinationer != null)
                {
                    fast = dto.DagligFastOrdinationer;
                    antalPatienter += fast.Count;
                }

                if (dto.DagligSk√¶vOrdinationer != null)
                {
                    sk√¶v = dto.DagligSk√¶vOrdinationer;
                    antalPatienter += sk√¶v.Count;
                }
            }
            else
            {
                pns = new List<PNVaegtDTO>();
                fast = new List<DagligFastVaegtDTO>();
                sk√¶v = new List<DagligSk√¶vVaegtDTO>();
                antalPatienter = 0;
            }
        }
        else
        {
            errorMessage = "Et l√¶gemiddel skal indtastes";
        }
        
        StateHasChanged();
    }
    
}